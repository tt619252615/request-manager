# RequestManager é¡¹ç›®å®Œå–„æ€»ç»“

> åŸºäºFastAPI + Reactçš„HTTPè¯·æ±‚ç®¡ç†ä¸è°ƒåº¦ç³»ç»Ÿå®Œå–„æ–¹æ¡ˆ

## ğŸ“‹ åç«¯APIç»“æ„åˆ†æ

### 1. æ ¸å¿ƒAPIæ¥å£

#### HTTPè¯·æ±‚ç®¡ç† (`/api/requests/`)
- **GET** `/api/requests/` - è·å–è¯·æ±‚åˆ—è¡¨ï¼Œæ”¯æŒåˆ†é¡µã€æœç´¢ã€è¿‡æ»¤
- **POST** `/api/requests/` - åˆ›å»ºæ–°è¯·æ±‚
- **GET** `/api/requests/{id}` - è·å–è¯·æ±‚è¯¦æƒ…
- **PUT** `/api/requests/{id}` - æ›´æ–°è¯·æ±‚
- **DELETE** `/api/requests/{id}` - åˆ é™¤è¯·æ±‚
- **POST** `/api/requests/import/fiddler` - ä»Fiddler Rawæ ¼å¼å¯¼å…¥
- **POST** `/api/requests/import/curl` - ä»cURLå‘½ä»¤å¯¼å…¥
- **POST** `/api/requests/{id}/test` - æµ‹è¯•è¯·æ±‚
- **POST** `/api/requests/{id}/duplicate` - å¤åˆ¶è¯·æ±‚

#### ä»»åŠ¡ç®¡ç† (`/api/tasks/`)
- **GET** `/api/tasks/` - è·å–ä»»åŠ¡åˆ—è¡¨
- **POST** `/api/tasks/` - åˆ›å»ºä»»åŠ¡
- **GET** `/api/tasks/{id}` - è·å–ä»»åŠ¡è¯¦æƒ…
- **PUT** `/api/tasks/{id}` - æ›´æ–°ä»»åŠ¡
- **DELETE** `/api/tasks/{id}` - åˆ é™¤ä»»åŠ¡
- **POST** `/api/tasks/{id}/start` - å¯åŠ¨ä»»åŠ¡
- **POST** `/api/tasks/{id}/stop` - åœæ­¢ä»»åŠ¡
- **POST** `/api/tasks/{id}/status` - æ›´æ–°ä»»åŠ¡çŠ¶æ€
- **POST** `/api/tasks/{id}/duplicate` - å¤åˆ¶ä»»åŠ¡
- **GET** `/api/tasks/stats/summary` - è·å–ä»»åŠ¡ç»Ÿè®¡

#### æ‰§è¡Œè®°å½• (`/api/executions/`)
- **GET** `/api/executions/` - è·å–æ‰§è¡Œè®°å½•åˆ—è¡¨
- **GET** `/api/executions/{id}` - è·å–æ‰§è¡Œè®°å½•è¯¦æƒ…
- **GET** `/api/executions/task/{task_id}` - è·å–ä»»åŠ¡æ‰§è¡Œè®°å½•
- **GET** `/api/executions/stats` - è·å–æ‰§è¡Œç»Ÿè®¡
- **DELETE** `/api/executions/{id}` - åˆ é™¤æ‰§è¡Œè®°å½•
- **POST** `/api/executions/cleanup` - æ¸…ç†æ‰§è¡Œè®°å½•

### 2. ç»Ÿä¸€å“åº”æ ¼å¼

æ‰€æœ‰APIéƒ½ä½¿ç”¨ç»Ÿä¸€çš„BaseResponseæ ¼å¼ï¼š

```json
{
  "code": 0,                    // 0=æˆåŠŸï¼Œé0=é”™è¯¯
  "data": {...},               // å®é™…æ•°æ®
  "message": "æ“ä½œæˆåŠŸ",        // å“åº”æ¶ˆæ¯
  "timestamp": 1749646958503   // æ—¶é—´æˆ³
}
```

## ğŸ”§ å‰ç«¯ä¿®å¤å†…å®¹

### 1. å¯¼å…¥è·¯å¾„é—®é¢˜ä¿®å¤

**é—®é¢˜**ï¼šViteæ— æ³•è§£æ`@/types/api`å¯¼å…¥è·¯å¾„
**è§£å†³æ–¹æ¡ˆ**ï¼š
- å°†`const enum ErrorCodes`æ”¹ä¸ºæ™®é€š`enum ErrorCodes`
- ç»Ÿä¸€ä½¿ç”¨ç›¸å¯¹è·¯å¾„å¯¼å…¥ï¼š`../types/api`

### 2. APIå®¢æˆ·ç«¯ä¼˜åŒ–

**ä¿®å¤å†…å®¹**ï¼š
- æ­£ç¡®å¤„ç†`BaseResponse`æ ¼å¼
- å¢åŠ nullå€¼æ£€æŸ¥å’Œé»˜è®¤å€¼å¤„ç†
- å®Œå–„é”™è¯¯å¤„ç†å’Œç”¨æˆ·æç¤º
- æ·»åŠ `getRaw`, `postRaw`ç­‰æ–¹æ³•

### 3. ç»„ä»¶æ•°æ®å¤„ç†å¢å¼º

**Dashboardé¡µé¢**ï¼š
- ä½¿ç”¨`Promise.allSettled`å¹¶è¡ŒåŠ è½½æ•°æ®
- æ·»åŠ å®Œå–„çš„é”™è¯¯å¤„ç†å’Œé»˜è®¤å€¼
- å¢åŠ æ‰§è¡Œç»Ÿè®¡æ˜¾ç¤º
- ä¼˜åŒ–åŠ è½½çŠ¶æ€å’Œç”¨æˆ·åé¦ˆ

**Tasks/Requestsé¡µé¢**ï¼š
- å¢åŠ æ•°ç»„ç±»å‹æ£€æŸ¥
- é˜²æ­¢éæ•°ç»„æ•°æ®å¯¼è‡´æ¸²æŸ“é”™è¯¯
- æ·»åŠ è°ƒè¯•ä¿¡æ¯ä¾¿äºé—®é¢˜æ’æŸ¥

### 4. æ–°å¢æ‰§è¡Œè®°å½•API

åˆ›å»ºäº†å®Œæ•´çš„æ‰§è¡Œè®°å½•APIæœåŠ¡(`executionApi.ts`)ï¼š
- æ”¯æŒæ‰§è¡Œè®°å½•æŸ¥è¯¢ã€ç»Ÿè®¡
- ä»»åŠ¡æ‰§è¡Œå†å²æŸ¥çœ‹
- æ‰§è¡Œè®°å½•æ¸…ç†åŠŸèƒ½

## ğŸ¯ demo.pyä»»åŠ¡é€»è¾‘é›†æˆ

### 1. æ ¸å¿ƒå‚è€ƒé€»è¾‘

ä»`demo.py`ä¸­æå–çš„å…³é”®ä»»åŠ¡æ‰§è¡Œé€»è¾‘ï¼š

#### é‡è¯•æœºåˆ¶
```python
def _run_retry(self):
    retry_config = self.task.retry_config
    max_attempts = retry_config.get("max_attempts", 10)
    interval_seconds = retry_config.get("interval_seconds", 5)
    success_condition = retry_config.get("success_condition")
    stop_condition = retry_config.get("stop_condition")
    
    # å¾ªç¯é‡è¯•é€»è¾‘
    while attempt < max_attempts and not self.stop_flag.is_set():
        # æ‰§è¡Œè¯·æ±‚
        # æ£€æŸ¥æˆåŠŸ/åœæ­¢æ¡ä»¶
        # ç­‰å¾…é—´éš”æ—¶é—´
```

#### ä»£ç†ç®¡ç†
```python
class ProxyManager:
    def get_random_proxy(self, proxy_config):
        # åŠ¨æ€è·å–ä»£ç†åˆ—è¡¨
        # éšæœºé€‰æ‹©ä»£ç†
        # æ”¯æŒä»£ç†è½®æ¢
```

#### å¤šçº¿ç¨‹æ‰§è¡Œ
```python
def run(self):
    seckill_threads = []
    for _ in range(self.thread_count):
        t = threading.Thread(target=self.start_seckill)
        t.start()
        seckill_threads.append(t)
```

### 2. åç«¯é›†æˆå®ç°

**è°ƒåº¦å™¨æœåŠ¡ (`SchedulerService`)**ï¼š
- é›†æˆäº†demo.pyçš„æ ¸å¿ƒè°ƒåº¦é€»è¾‘
- æ”¯æŒä»»åŠ¡çŠ¶æ€ç®¡ç†å’Œç”Ÿå‘½å‘¨æœŸæ§åˆ¶
- å®ç°äº†é‡è¯•æœºåˆ¶å’Œæ¡ä»¶åˆ¤æ–­

**ä»»åŠ¡æ‰§è¡Œå™¨ (`TaskRunner`)**ï¼š
- åŸºäºdemo.pyçš„æ‰§è¡Œé€»è¾‘
- æ”¯æŒå•æ¬¡æ‰§è¡Œå’Œé‡è¯•æ‰§è¡Œ
- é›†æˆä»£ç†ç®¡ç†å’Œå¤šçº¿ç¨‹æ”¯æŒ

**æ‰§è¡ŒæœåŠ¡ (`ExecutorService`)**ï¼š
- HTTPè¯·æ±‚å‘é€å’Œå“åº”å¤„ç†
- æ¡ä»¶éªŒè¯å’Œç»“æœè®°å½•
- é”™è¯¯å¤„ç†å’Œè¶…æ—¶ç®¡ç†

## ğŸš€ å®šæ—¶é‡å‘ä»»åŠ¡å®ç°

### 1. ä»»åŠ¡é…ç½®

```json
{
  "task_type": "retry",
  "retry_config": {
    "max_attempts": 10,           // æœ€å¤§é‡è¯•æ¬¡æ•°
    "interval_seconds": 5,        // é‡è¯•é—´éš”
    "success_condition": "response.status_code == 200",  // æˆåŠŸæ¡ä»¶
    "stop_condition": "response.status_code == 404"      // åœæ­¢æ¡ä»¶
  },
  "proxy_config": {
    "enabled": true,              // å¯ç”¨ä»£ç†
    "rotation": true,             // ä»£ç†è½®æ¢
    "timeout": 30                 // è¶…æ—¶æ—¶é—´
  },
  "thread_count": 1,              // çº¿ç¨‹æ•°
  "time_diff": 0                  // æ—¶é—´å·®è°ƒæ•´
}
```

### 2. æ‰§è¡Œæµç¨‹

1. **ä»»åŠ¡è°ƒåº¦**ï¼šè°ƒåº¦å™¨æŒ‰é…ç½®å¯åŠ¨ä»»åŠ¡
2. **è¯·æ±‚æ‰§è¡Œ**ï¼šå‘é€HTTPè¯·æ±‚å¹¶è®°å½•ç»“æœ
3. **æ¡ä»¶åˆ¤æ–­**ï¼šæ ¹æ®æˆåŠŸ/å¤±è´¥æ¡ä»¶åˆ¤æ–­æ˜¯å¦ç»§ç»­
4. **é‡è¯•æ§åˆ¶**ï¼šæŒ‰é—´éš”æ—¶é—´å’Œæœ€å¤§æ¬¡æ•°æ§åˆ¶é‡è¯•
5. **ç»“æœè®°å½•**ï¼šå°†æ‰§è¡Œç»“æœä¿å­˜åˆ°æ•°æ®åº“

### 3. å‰ç«¯ç•Œé¢

- **Dashboard**ï¼šå®æ—¶æ˜¾ç¤ºä»»åŠ¡å’Œæ‰§è¡Œç»Ÿè®¡
- **Tasksé¡µé¢**ï¼šä»»åŠ¡ç®¡ç†ã€å¯åœæ§åˆ¶ã€çŠ¶æ€ç›‘æ§
- **Requestsé¡µé¢**ï¼šè¯·æ±‚ç®¡ç†ã€æµ‹è¯•ã€å¯¼å…¥
- **æ‰§è¡Œè®°å½•**ï¼šæŸ¥çœ‹è¯¦ç»†çš„æ‰§è¡Œå†å²å’Œç»“æœ

## ğŸ”„ ä½¿ç”¨æµç¨‹

### 1. å¯¼å…¥è¯·æ±‚

```bash
# ä½¿ç”¨æµ‹è¯•è„šæœ¬å¯¼å…¥ç¾å›¢è¯·æ±‚
python test_meituan_import.py
```

### 2. åˆ›å»ºä»»åŠ¡

åœ¨å‰ç«¯ç•Œé¢ï¼š
1. è¿›å…¥Tasksé¡µé¢
2. ç‚¹å‡»"åˆ›å»ºä»»åŠ¡"
3. é€‰æ‹©å·²å¯¼å…¥çš„è¯·æ±‚
4. é…ç½®é‡è¯•å‚æ•°
5. å¯åŠ¨ä»»åŠ¡

### 3. ç›‘æ§æ‰§è¡Œ

- DashboardæŸ¥çœ‹å®æ—¶ç»Ÿè®¡
- Tasksé¡µé¢ç›‘æ§ä»»åŠ¡çŠ¶æ€
- æ‰§è¡Œè®°å½•æŸ¥çœ‹è¯¦ç»†ç»“æœ

## ğŸ“Š é¡¹ç›®ç‰¹æ€§

### âœ… å·²å®ç°åŠŸèƒ½

1. **å®Œæ•´çš„APIä½“ç³»**ï¼šè¯·æ±‚ç®¡ç†ã€ä»»åŠ¡è°ƒåº¦ã€æ‰§è¡Œè®°å½•
2. **é‡è¯•æœºåˆ¶**ï¼šåŸºäºdemo.pyçš„æ™ºèƒ½é‡è¯•é€»è¾‘
3. **ä»£ç†æ”¯æŒ**ï¼šåŠ¨æ€ä»£ç†è·å–å’Œè½®æ¢
4. **å¤šçº¿ç¨‹æ‰§è¡Œ**ï¼šæ”¯æŒå¹¶å‘è¯·æ±‚å¤„ç†
5. **æ¡ä»¶æ§åˆ¶**ï¼šçµæ´»çš„æˆåŠŸ/å¤±è´¥æ¡ä»¶åˆ¤æ–­
6. **å®æ—¶ç›‘æ§**ï¼šä»»åŠ¡çŠ¶æ€å’Œæ‰§è¡Œç»Ÿè®¡å®æ—¶æ›´æ–°
7. **æ•°æ®æŒä¹…åŒ–**ï¼šå®Œæ•´çš„æ‰§è¡Œå†å²è®°å½•

### ğŸ¯ æ ¸å¿ƒä¼˜åŠ¿

1. **æ˜“ç”¨æ€§**ï¼šç®€å•çš„Webç•Œé¢ï¼Œæ”¯æŒFiddlerå¯¼å…¥
2. **çµæ´»æ€§**ï¼šå¯é…ç½®çš„é‡è¯•ç­–ç•¥å’Œè°ƒåº¦è§„åˆ™
3. **å¯é æ€§**ï¼šåŸºäºdemo.pyéªŒè¯çš„æ‰§è¡Œé€»è¾‘
4. **å¯è§‚æµ‹æ€§**ï¼šè¯¦ç»†çš„æ‰§è¡Œæ—¥å¿—å’Œç»Ÿè®¡ä¿¡æ¯
5. **æ‰©å±•æ€§**ï¼šæ¨¡å—åŒ–è®¾è®¡ï¼Œä¾¿äºåŠŸèƒ½æ‰©å±•

## ğŸ› ï¸ ä¸‹ä¸€æ­¥å»ºè®®

1. **æ€§èƒ½ä¼˜åŒ–**ï¼šæ·»åŠ è¿æ¥æ± å’Œè¯·æ±‚ä¼˜åŒ–
2. **ç›‘æ§å‘Šè­¦**ï¼šé›†æˆé‚®ä»¶/æ¶ˆæ¯é€šçŸ¥
3. **ä»»åŠ¡æ¨¡æ¿**ï¼šé¢„è®¾å¸¸ç”¨ä»»åŠ¡é…ç½®
4. **æ•°æ®åˆ†æ**ï¼šæ‰§è¡Œç»“æœçš„ç»Ÿè®¡åˆ†æ
5. **é›†ç¾¤æ”¯æŒ**ï¼šåˆ†å¸ƒå¼ä»»åŠ¡è°ƒåº¦

---

âœ… **é¡¹ç›®çŠ¶æ€**ï¼šæ ¸å¿ƒåŠŸèƒ½å·²å®Œæˆï¼Œå‰åç«¯é›†æˆå®Œæ¯•ï¼Œå¯ä»¥æ­£å¸¸ä½¿ç”¨å®šæ—¶é‡å‘åŠŸèƒ½ã€‚ 